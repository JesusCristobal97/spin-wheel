<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario Dinámico</title>
  <link rel="stylesheet" href="./css/bootstrap.min.css">
</head>
<body>
  <div class="container mt-5">
    <h3 class="mb-4">Configurador</h3>
    <h5>Cantidad máxima de REGALO ESPECIAL</h5>
      <div class="container" id="divBalls">
      
      </div>
      <div class="container">
          <input type="button" class="btn btn-success" value="Guardar" />
      </div>
      <br/>
      <div class="container" id="divGifts">
        <h5>Tarjeta Regalo por día</h5> 
        <div class="row" id="divGiftsRow">
 
          
        </div>
      </div>
  </div>


  <script src="./js/jquery-3.5.1.min.js"></script>  
  <script src="./js/bootstrap.min.js"></script>

  <script>
    var configBase = [];
    async function loadJsonData (){
      var localConfigBase = localStorage.getItem("configBase");
      if(localConfigBase != null){
        configBase = JSON.parse(localConfigBase);
      }else{
        try {
          const response = await fetch('./database/getDataBase.json'); 
          if (!response.ok) {
            throw new Error(`Error al cargar el JSON: ${response.status} ${response.statusText}`);
          }
          const getDataBase = await response.json();
          configBase = getDataBase; 
          localStorage.setItem("configBase", JSON.stringify(configBase)); 

        } catch (error) {
          console.error("Error cargando el JSON:", error);
        }
      }
    }
    

    window.onload = async function() {
      await loadJsonData();
      loadFieldsJSON();
      loadFieldsGifts();
    };


    function loadFieldsJSON() {
      var html = "<div class='row'>";
        for (let i = 0; i < configBase.balls.length; i++) {
          html += "<div class='col-4'>"
                +"<div class='form-group row'>"
                  +"<label for='staticEmail' class='col-sm-2 col-form-label'>Dia</label>"
                  + "<div class='col-sm-10'>"
                    + "<input type='text' readonly class='form-control' id='staticEmail' value='"+ configBase.balls[i].day +"'>"
                  + "</div>"
                  +"</div>"
                +"</div>";
         html += "<div class='col-4'>"
                +"<div class='form-group row'>"
                  +"<label for='staticEmail' class='col-sm-2 col-form-label'>Regalos</label>"
                  + "<div class='col-sm-10'>"
                    + "<input type='text' class='form-control' id='staticEmail' value='"+ configBase.balls[i].count +"'>"
                  + "</div>"
                  +"</div>"
                +"</div>";
          
         html += "<div class='col-4'>"
                +"<div class='form-group row'>"
                  +"<label for='staticEmail' class='col-sm-2 col-form-label'>Máximo</label>"
                  + "<div class='col-sm-10'>"
                    + "<input type='text' class='form-control' id='staticEmail' value='"+ configBase.balls[i].max +"'>"
                  + "</div>"
                  +"</div>"
                +"</div>"; 
        }
        html+= "</div>"; 
        $("#divBalls").append(html);
      }
    
    function loadFieldsGifts (){
      var html = "";
      for (let index = 0; index < configBase.gifts.length; index++) {
        const element = configBase.gifts[index];
        html += "<div class='col-4'>"
                +"<div class='form-group row'>"  
                  + "<div class='col-sm-8'>"
                    + "<input type='text' disabled class='form-control' id='staticEmail' value='"+ element +"'>"
                  + "</div>"
                  +"</div>"
            +"</div>"; 
      }
      $("#divGiftsRow").append(html);
    }

    function saveJsonData() {
        // Inicializamos un array vacío para los nuevos valores
        const updatedBalls = [];

        // Seleccionamos los contenedores de las columnas generadas dinámicamente
        const rows = document.querySelectorAll("#divBalls .row"); // Asegúrate de que el contenedor principal tenga un ID correcto
        
        rows.forEach(row => {
            // Extraemos los valores de los inputs en cada columna
            const dayInput = row.querySelector("input[readonly]").value; // Para "Dia"
            const countInput = row.querySelector("input:not([readonly]):nth-of-type(1)").value; // Para "Regalos"
            const maxInput = row.querySelector("input:not([readonly]):nth-of-type(2)").value; // Para "Máximo"

            // Añadimos los valores al array como un objeto
            updatedBalls.push({
                day: dayInput,
                count: parseInt(countInput), // Convertimos a número si es necesario
                max: parseInt(maxInput) // Convertimos a número si es necesario
            });
        });

        // Actualizamos el objeto `configBase`
        configBase.balls = updatedBalls;

        // Guardamos el objeto actualizado en localStorage
        localStorage.setItem("configBase", JSON.stringify(configBase));

        console.log("Datos guardados exitosamente en localStorage:", updatedBalls);
    }

    // Llamar al método cuando se necesite guardar
    document.getElementById("saveButton").addEventListener("click", saveJsonData);
 
  </script>


</body>
</html>
